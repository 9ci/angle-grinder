(function() {
    var flatten, gridz, hasSearchFilters;
    gridz = angular.module("angleGrinder.gridz", []);
    gridz.directive("agGrid", [ "hasSearchFilters", function(hasSearchFilters) {
        var link;
        link = function($scope, element, attrs) {
            var $grid, flashRowFor, gridOptions, invokeEditItemDialogFor;
            $grid = $("#grid", element);
            gridOptions = $scope.$eval(attrs.agGrid);
            $grid.gridz(gridOptions);
            invokeEditItemDialogFor = function(id) {
                return $scope.$apply(function() {
                    return $scope.editDialog(id);
                });
            };
            flashRowFor = function(item, complete) {
                var $row;
                if (complete == null) {
                    complete = function() {};
                }
                $row = $($grid[0].rows.namedItem(item.id));
                $row.css("background-color", "#DFF0D8");
                $row.delay(100).fadeOut("medium", function() {
                    return $row.css("background-color", "");
                });
                return $row.fadeIn("fast", function() {
                    return complete();
                });
            };
            $grid.on("editAction", function(event, id) {
                event.preventDefault();
                return invokeEditItemDialogFor(id);
            });
            $grid.on("click", "a.editActionLink", function(event) {
                var id;
                event.preventDefault();
                id = $(this).parents("tr:first").attr("id");
                return invokeEditItemDialogFor(id);
            });
            $grid.on("deleteAction", function(event, id) {
                event.preventDefault();
                return $scope.$apply(function() {
                    return $scope.deleteItem(id);
                });
            });
            $grid.on("jqGridAfterLoadComplete", function() {
                return $scope.$broadcast("gridzLoadComplete");
            });
            $scope.$on("itemUpdated", function(event, item) {
                if ($grid.jqGrid("getInd", item.id)) {
                    $grid.jqGrid("setRowData", item.id, item);
                } else {
                    $grid.jqGrid("addRowData", item.id, item, "first");
                }
                return flashRowFor(item);
            });
            $scope.$on("itemDeleted", function(event, item) {
                return flashRowFor(item, function() {
                    return $grid.jqGrid("delRowData", item.id);
                });
            });
            return $scope.$on("searchUpdated", function(event, filters) {
                var params;
                params = {
                    search: hasSearchFilters(filters),
                    postData: {
                        filters: JSON.stringify(filters)
                    }
                };
                return $grid.setGridParam(params).trigger("reloadGrid");
            });
        };
        return {
            restrict: "A",
            template: '<table id="grid"></table>\n<div id="gridPager"></div>',
            link: link
        };
    } ]);
    flatten = function(target, opts) {
        var delimiter, getKey, output, step;
        if (opts == null) {
            opts = {
                delimiter: "."
            };
        }
        delimiter = opts.delimiter;
        getKey = function(key, prev) {
            if (prev) {
                return prev + delimiter + key;
            } else {
                return key;
            }
        };
        step = function(object, prev) {
            return Object.keys(object).forEach(function(key) {
                var isarray, isobject, type;
                isarray = opts.safe && Array.isArray(object[key]);
                type = Object.prototype.toString.call(object[key]);
                isobject = type === "[object Object]" || type === "[object Array]";
                if (!isarray && isobject) {
                    return step(object[key], getKey(key, prev));
                }
                return output[getKey(key, prev)] = object[key];
            });
        };
        output = {};
        step(target);
        return output;
    };
    gridz.value("flatten", flatten);
    hasSearchFilters = function(filters) {
        var value, _;
        for (_ in filters) {
            value = filters[_];
            if (value == null) {
                continue;
            }
            if (typeof value === "string") {
                if (value.trim() !== "") {
                    return true;
                }
            } else {
                return true;
            }
        }
        return false;
    };
    gridz.value("hasSearchFilters", hasSearchFilters);
    gridz.directive("searchButton", function() {
        return {
            restrict: "E",
            replace: true,
            template: '<button type="button" ng-click="advancedSearch(search)" ng-class="{disabled: searching}" class="btn btn-info">\n  <i class="icon-search icon-white"></i> Search<span ng-show="searching">...</span>\n</button>'
        };
    });
    gridz.directive("resetSearchButton", function() {
        return {
            restrict: "E",
            replace: true,
            template: '<button type="button" ng-click="resetSearch()" ng-class="{disabled: searching}" class="btn">\n  <i class="icon-remove"></i> Reset<span ng-show="searching">...</span>\n</button>'
        };
    });
    gridz.directive("searchForm", [ "$rootScope", function($rootScope) {
        return {
            restrict: "A",
            scope: false,
            link: function($scope, element, attrs) {
                $scope.searching = false;
                $scope.search = {};
                $scope.advancedSearch = function(search) {
                    $scope.searching = true;
                    return $rootScope.$broadcast("searchUpdated", search);
                };
                $scope.$on("gridzLoadComplete", function() {
                    return $scope.searching = false;
                });
                return $scope.resetSearch = function() {
                    $scope.search = {};
                    return $scope.advancedSearch($scope.search);
                };
            }
        };
    } ]);
}).call(this);